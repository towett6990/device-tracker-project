{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-4">üìä Device Dashboard</h1>

  <!-- Quick Actions -->
  <div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('add_device') }}" class="btn btn-success">‚ûï Add Device</a>
    <a href="{{ url_for('lost_device') }}" class="btn btn-warning">üîç Find Lost Device</a>
    <a href="{{ url_for('logout') }}" class="btn btn-danger">üö™ Logout</a>
  </div>

  <!-- Search Bar -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="üîé Search by name, serial number, or location">
  </div>

  <!-- Devices Table -->
  <div class="table-responsive mb-4">
    <table class="table table-dark table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Serial Number</th>
          <th>Name</th>
          <th>Make</th>
          <th>Model</th>
          <th>Type</th>
          <th>Status</th>
          <th>Location</th>
          <th>OS</th>
          <th>Last Updated</th>
        </tr>
      </thead>
      <tbody id="deviceTable">
        {% for device in devices %}
        <tr>
          <td>{{ device.id }}</td>
          <td>{{ device.serial_number }}</td>
          <td>{{ device.name }}</td>
          <td>{{ device.make }}</td>
          <td>{{ device.model }}</td>
          <td>{{ device.device_type }}</td>
          <td>
            {% if device.current_status == "active" %}
              <span class="badge bg-success">Active</span>
            {% elif device.current_status == "lost" %}
              <span class="badge bg-danger">Lost</span>
            {% elif device.current_status == "stolen" %}
              <span class="badge bg-dark">Stolen</span>
            {% elif device.current_status == "repair" %}
              <span class="badge bg-warning text-dark">Repair</span>
            {% else %}
              <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          </td>
          <td>{{ device.current_location }}</td>
          <td>{{ device.os_version or "N/A" }}</td>
          <td>{{ device.last_updated.strftime("%Y-%m-%d %H:%M:%S") if device.last_updated else "Never" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Map -->
  <div id="map" style="height: 500px; border-radius: 10px;"></div>
  <div class="mt-3 text-center">
    <button id="toggleTrails" class="btn btn-outline-info">üîÑ Toggle Movement Trails</button>
  </div>

  <!-- Alert Sound -->
  <audio id="alertSound" src="{{ url_for('static', filename='alert.mp3') }}" preload="auto"></audio>
</div>

<script>
  // üîé Table Search
  document.getElementById("searchInput").addEventListener("keyup", function() {
    let filter = this.value.toLowerCase();
    let rows = document.querySelectorAll("#deviceTable tr");
    rows.forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
  });

  // üåç Leaflet Map Setup
  const map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let deviceMarkers = {};
  let deviceTrails = {};
  let showTrails = false;
  let firstLoad = true;

  document.getElementById("toggleTrails").addEventListener("click", () => {
    showTrails = !showTrails;
    for (let id in deviceTrails) {
      if (showTrails) {
        deviceTrails[id].addTo(map);
      } else {
        map.removeLayer(deviceTrails[id]);
      }
    }
  });

  // üîÑ Fetch & Update Devices
  async function fetchDevices() {
    try {
      const response = await fetch("{{ url_for('get_devices') }}");
      const devices = await response.json();

      devices.forEach(device => {
        if (device.latitude && device.longitude) {
          let latlng = [device.latitude, device.longitude];

          // Update marker
          if (!deviceMarkers[device.id]) {
            deviceMarkers[device.id] = L.marker(latlng).addTo(map)
              .bindPopup(`<b>${device.name}</b><br>
                Serial: ${device.serial_number}<br>
                Status: ${device.current_status}<br>
                Last Updated: ${device.last_updated}`);
            deviceTrails[device.id] = L.polyline([latlng], { color: "blue" });
          } else {
            deviceMarkers[device.id].setLatLng(latlng);
            deviceMarkers[device.id].setPopupContent(`<b>${device.name}</b><br>
              Serial: ${device.serial_number}<br>
              Status: ${device.current_status}<br>
              Last Updated: ${device.last_updated}`);
            deviceTrails[device.id].addLatLng(latlng);
          }

          // üö® Play alert if lost/stolen
          if (device.current_status === "lost" || device.current_status === "stolen") {
            document.getElementById("alertSound").play().catch(() => {});
          }
        }
      });

      // Fit bounds on first load
      if (firstLoad && Object.keys(deviceMarkers).length > 0) {
        map.fitBounds(Object.values(deviceMarkers).map(m => m.getLatLng()), { padding: [50, 50] });
        firstLoad = false;
      }
    } catch (error) {
      console.error("Error fetching devices:", error);
    }
  }

  fetchDevices();
  setInterval(fetchDevices, 5000); // Refresh every 5s
</script>
{% endblock %}
