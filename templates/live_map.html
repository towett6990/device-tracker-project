{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3 text-light">Live Tracking for Device: {{ device.serial_number }}</h2>
  
  <!-- Map -->
  <div id="map" style="height: 500px; border-radius: 10px;"></div>

  <!-- Controls -->
  <div class="mt-3 d-flex justify-content-between">
    <button onclick="toggleFollow()" class="btn btn-warning btn-sm">üìç Toggle Follow</button>
  </div>

  <!-- Loading Indicator -->
  <div id="loading" style="display:none; text-align:center; margin-top:10px;">
    <span>‚è≥ Updating...</span>
  </div>
</div>

<!-- Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    // Initialize map
    var map = L.map('map').setView([0.0, 0.0], 2);

    // Map layers
    var liveFeed = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    });

    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/' +
        'World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles ¬© Esri'
    });

    liveFeed.addTo(map);

    var baseMaps = {
        "Live Feed": liveFeed,
        "Satellite": satellite
    };
    L.control.layers(baseMaps).addTo(map);

    // Marker + Trail
    var marker;
    var trail = L.polyline([], { color: 'lime', weight: 3 }).addTo(map);

    // Follow toggle
    var followDevice = true;
    function toggleFollow() {
        followDevice = !followDevice;
        alert("Follow mode: " + (followDevice ? "ON" : "OFF"));
    }

    // Fetch device location
    async function loadDevice() {
        try {
            document.getElementById("loading").style.display = "block";
            let res = await fetch(`/api/device_location/{{ device.serial_number }}`);
            let d = await res.json();
            document.getElementById("loading").style.display = "none";

            if (d.error) return;

            if (d.latitude && d.longitude) {
                let latLng = [d.latitude, d.longitude];
                let lastSeen = d.last_seen ? new Date(d.last_seen).toLocaleString() : "N/A";

                if (marker) {
                    marker.setLatLng(latLng)
                          .setPopupContent(`<b>${d.name}</b><br>Serial: ${d.serial_number}<br>Last Seen: ${lastSeen}`);
                    trail.addLatLng(latLng);
                } else {
                    marker = L.marker(latLng).addTo(map)
                        .bindPopup(`<b>${d.name}</b><br>Serial: ${d.serial_number}<br>Last Seen: ${lastSeen}`);
                    map.setView(latLng, 15);
                    trail.addLatLng(latLng);
                }

                if (followDevice) map.setView(latLng, 15);
            }

        } catch (err) {
            console.error("Error loading device:", err);
            document.getElementById("loading").style.display = "none";
        }
    }

    // Initial load + refresh every 5s
    loadDevice();
    setInterval(loadDevice, 5000);
</script>

<style>
  body {
    background-color: #121212;
    color: white;
  }
  #map {
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
</style>
{% endblock %}
